---
description: 
globs: 
alwaysApply: false
---
---
description: BFF testing guidelines
globs: ["./api/**/*.spec*", "./services/**/*.spec*", "./common/**/*.spec*", "*/middlewares/**/*.spec*", ]
alwaysApply: true
---

# BFF Testing Guidelines

## Instru√ß√µes para LLM

**A√á√ÉO OBRIGAT√ìRIA**: Quando solicitado para criar ou revisar testes de BFF, siga EXATAMENTE esta sequ√™ncia:

1. **VERIFICAR**: Confirme se a solicita√ß√£o se enquadra nos crit√©rios da se√ß√£o "Quando Aplicar"
2. **ANALISAR**: Execute an√°lise do c√≥digo BFF a ser testado usando ferramentas dispon√≠veis
3. **ESTRUTURAR**: Organize os testes seguindo os padr√µes estabelecidos
4. **IMPLEMENTAR**: Use os patterns e melhores pr√°ticas definidas
5. **VERIFICAR LINT**: Execute `npx eslint [arquivo]` para verificar erros de lint APENAS no arquivo espec√≠fico
6. **EXECUTAR TESTES**: Execute `npm test [arquivo.spec.ts]` para validar que o teste espec√≠fico passa
7. **VALIDAR**: Verifique se seguiu todas as diretrizes antes de finalizar

**ECONOMIA DE RECURSOS**: SEMPRE execute lint e testes apenas nos arquivos espec√≠ficos, n√£o no projeto todo

**NOMENCLATURA OBRIGAT√ìRIA**: Usar `.spec.ts` ou `.spec.js` para arquivos de teste

**LOCALIZA√á√ÉO OBRIGAT√ìRIA**: Mesmo diret√≥rio do arquivo sendo testado

## Fluxo de Desenvolvimento Linear

```
IN√çCIO
  ‚Üì
üìã Consultar [Matriz de Prioridades](mdc:#0-matriz-de-prioridades)
  ‚Üì
üîç Executar [An√°lise do C√≥digo BFF](mdc:#1-an√°lise-do-c√≥digo-bff)
  ‚Üì
üõ†Ô∏è Aplicar [Padr√µes de Testing BFF](mdc:#padr√µes-de-testing-bff) + [Mocking de APIs](mdc:#estrat√©gias-de-mocking)
  ‚Üì
‚öñÔ∏è Conflito? ‚Üí [Resolu√ß√£o de Conflitos](mdc:#resolu√ß√£o-de-conflitos)
  ‚Üì
‚úÖ [Verifica√ß√£o e Valida√ß√£o](mdc:#comandos-de-verifica√ß√£o)
  ‚Üì
üéØ FINALIZADO
```

## Modo R√°pido (Para mudan√ßas simples)

**Use quando**: Pequenas corre√ß√µes, ajustes de utilit√°rios, ou mudan√ßas triviais

**Processo simplificado**:
1. ‚úÖ Verificar se √© realmente simples (sem l√≥gica complexa de API)
2. üõ†Ô∏è Implementar seguindo padr√µes b√°sicos
3. üîç Executar `npx eslint [arquivo]`
4. ‚úÖ Validar apenas itens "Cr√≠ticos" do checklist

**Pular para casos simples**: An√°lise detalhada, documenta√ß√£o extensa, valida√ß√£o completa

## Quando Aplicar

Esta rule deve ser aplicada quando:
- Solicitado para criar testes de handlers de API
- Necess√°rio testar services e integra√ß√µes externas
- Requerido implementar testes de middleware
- Preciso testar tratamento de erros e valida√ß√µes
- Solicitado para testar utilit√°rios e helpers do BFF

## √çndice de Navega√ß√£o R√°pida

- üö® [Matriz de Prioridades](mdc:#0-matriz-de-prioridades) - **Consulte PRIMEIRO**
- ‚öñÔ∏è [Resolu√ß√£o de Conflitos](mdc:#resolu√ß√£o-de-conflitos) - Para decis√µes dif√≠ceis
- üîç [An√°lise do C√≥digo BFF](mdc:#1-an√°lise-do-c√≥digo-bff) - In√≠cio do desenvolvimento
- üõ†Ô∏è [Padr√µes de Testing BFF](mdc:#padr√µes-de-testing-bff) - Durante implementa√ß√£o
- ‚úÖ [Checklist Final](mdc:#checklist-de-valida√ß√£o-para-llm) - Antes de finalizar

## 0. Matriz de Prioridades

### Cr√≠tico (Bloqueia desenvolvimento)
- Lint sem erros no arquivo de teste
- Teste espec√≠fico executando e passando
- Mocks de APIs externas funcionais
- Nomenclatura correta (.spec.ts/.spec.js)

### Importante (Impacta qualidade)
- AAA pattern (Arrange-Act-Assert)
- Cen√°rios de sucesso e erro cobertos
- Mocks de middleware e autentica√ß√£o
- Estrutura de describe/it organizada

### Opcional (Melhoria incremental)
- Edge cases de APIs testados
- Cobertura de c√≥digo alta
- Testes de integra√ß√£o
- Performance de execu√ß√£o

## Resolu√ß√£o de Conflitos

### Ordem de Preced√™ncia:
1. **Funcionalidade > Padr√µes**: Se um padr√£o impede a funcionalidade, priorize a funcionalidade
2. **Seguran√ßa > Performance**: Nunca comprometa seguran√ßa por performance
3. **Legibilidade > Otimiza√ß√£o**: C√≥digo leg√≠vel √© mais importante que micro-otimiza√ß√µes
4. **Conven√ß√µes do projeto > Prefer√™ncias pessoais**: Siga o que j√° existe no projeto

### Protocolo de Decis√£o:
1. **Identifique o conflito**: Qual diretriz est√° sendo violada?
2. **Consulte a preced√™ncia**: Use a ordem acima para decidir
3. **Documente a exce√ß√£o**: Explique por que divergiu
4. **Valide o m√≠nimo**: Garanta que itens "Cr√≠ticos" ainda s√£o atendidos

### Exemplos Pr√°ticos:
```typescript
// ‚ùå Conflito: Padr√£o vs Funcionalidade
// Padr√£o diz: mock todas as depend√™ncias
// Mas: teste de integra√ß√£o precisa de API real

// ‚úÖ Resolu√ß√£o: Priorizar funcionalidade
// Coment√°rio: "Teste de integra√ß√£o - API real necess√°ria para validar fluxo completo"
```

### Quando Divergir:
- **Documente**: Adicione coment√°rio explicando a exce√ß√£o
- **Valide cr√≠ticos**: Confirme que lint, tipos e mocks ainda funcionam
- **Priorize entrega**: Funcionalidade working > padr√£o perfeito

## 1. An√°lise do C√≥digo BFF

**ANTES DE INICIAR**: Consulte a [Matriz de Prioridades](mdc:#0-matriz-de-prioridades)

**EXECUTAR OBRIGATORIAMENTE:**

- **Funcionalidade**: Identificar handlers, services ou middleware a serem testados
- **Depend√™ncias**: Mapear APIs externas, banco de dados e depend√™ncias
- **Comportamentos**: Listar cen√°rios de sucesso, erro e edge cases
- **Autentica√ß√£o**: Analisar necessidades de mock de auth/autoriza√ß√£o
- **Valida√ß√µes**: Identificar schemas Zod e valida√ß√µes de entrada

**A√á√ÉO**: Use `read_file` e `codebase_search` para analisar o c√≥digo fonte.

### Diretrizes de An√°lise
- Identifique funcionalidades principais a serem testadas
- Mapeie depend√™ncias externas que precisam de mock
- Liste cen√°rios de API (200, 400, 401, 404, 500)
- Prossiga com implementa√ß√£o quando tiver clareza dos requisitos

## 2. Estrutura√ß√£o dos Testes

**A√á√ïES OBRIGAT√ìRIAS:**

- **Arquivo de teste**: Criar na mesma pasta do arquivo fonte
- **Nomenclatura**: Usar `.spec.ts` ou `.spec.js`
- **Organiza√ß√£o**: Estruturar com `describe` e `it`
- **Setup**: Configurar mocks de APIs, auth e depend√™ncias

## 3. Implementa√ß√£o

**DIRETRIZES OBRIGAT√ìRIAS:**

- **AAA Pattern**: Arrange-Act-Assert em todos os testes
- **Descri√ß√µes em ingl√™s**: Nomes de testes claros e descritivos
- **Mocking apropriado**: Mock APIs externas e depend√™ncias
- **Cleanup**: Limpar mocks entre testes

## 4. Verifica√ß√£o e Valida√ß√£o

**EM CASO DE CONFLITO**: Consulte [Resolu√ß√£o de Conflitos](mdc:#resolu√ß√£o-de-conflitos)

**EXECUTAR OBRIGATORIAMENTE antes de finalizar:**

- **Verifica√ß√£o de Lint**: Use `run_terminal_cmd` com `npx eslint [arquivo]` para verificar erros de lint no arquivo espec√≠fico
- **Corre√ß√£o de Lint**: Se houver erros, corrija-os antes de prosseguir
- **Execu√ß√£o de Testes**: Use `run_terminal_cmd` com `npm test [arquivo.spec.ts]` para executar apenas o teste espec√≠fico
- **Valida√ß√£o de Resultados**: Confirme que o teste espec√≠fico passa

**A√á√ïES OBRIGAT√ìRIAS:**
```bash
# 1. Verificar lint apenas no arquivo espec√≠fico (economiza recursos)
npx eslint api/handlers/example/example.ts

# 2. Se lint passou, executar apenas o teste espec√≠fico
npm test example.spec.ts

# 3. Verificar se o teste espec√≠fico passa
# 4. Se o teste falhar, corrigir antes de finalizar
```

**IMPORTANTE**: N√£o finalize a implementa√ß√£o de testes se houver:
- Erros de lint n√£o corrigidos no arquivo espec√≠fico
- Teste espec√≠fico falhando
- Warnings cr√≠ticos n√£o resolvidos no arquivo

## Testing Framework

### Tecnologias Principais
- **Unit Tests**: Jest
- **Test Environment**: Node.js
- **Mocking**: Jest mocks
- **HTTP Testing**: Supertest (quando aplic√°vel)

### Filosofia de Testing
- Escrever descri√ß√µes de testes em ingl√™s
- Manter testes independentes
- Testar cen√°rios de sucesso e erro
- Focar em testar comportamento, n√£o implementa√ß√£o

## Configura√ß√£o e Setup de Testes

### Setup Inicial de Testes

```typescript
// Imports obrigat√≥rios para BFF
import { Request, Response } from 'express';
import { jest } from '@jest/globals';

// Mock de depend√™ncias externas
jest.mock('nordic/restclient');
jest.mock('nordic/logger');
jest.mock('odin/security');

// Setup e cleanup
beforeEach(() => {
  jest.clearAllMocks();
});
```

### Estrutura de Arquivos e Nomenclatura

- Usar extens√£o `.spec.ts` ou `.spec.js`
- Colocar arquivos de teste na mesma pasta do arquivo fonte
- Seguir conven√ß√£o de nomenclatura:

```
‚î£ api/
‚îÉ ‚î£ handlers/
‚îÉ ‚îÉ ‚î£ example/
‚îÉ ‚îÉ ‚îÉ ‚î£ example.ts
‚îÉ ‚îÉ ‚îÉ ‚î£ example.spec.ts
‚î£ services/
‚îÉ ‚î£ external-api/
‚îÉ ‚îÉ ‚î£ external-api.ts
‚îÉ ‚îÉ ‚î£ external-api.spec.ts
```

## Padr√µes de Testing BFF

### Testing de Handlers

```typescript
describe('exampleHandler', () => {
  let mockRequest: Partial<Request>;
  let mockResponse: Partial<Response>;

  beforeEach(() => {
    mockRequest = {
      body: {},
      auth: { user: { userId: 'test-user' } },
      context: { requestId: 'test-request' },
    };
    mockResponse = {
      json: jest.fn(),
      status: jest.fn().mockReturnThis(),
    };
  });

  it('should return success response when valid data is provided', async () => {
    // Arrange
    mockRequest.body = { name: 'Test', email: 'test@example.com' };

    // Act
    await exampleHandler(mockRequest as Request, mockResponse as Response);

    // Assert
    expect(mockResponse.json).toHaveBeenCalledWith({
      id: expect.any(String),
      name: 'Test',
      email: 'test@example.com',
    });
  });

  it('should return 400 when validation fails', async () => {
    // Arrange
    mockRequest.body = { name: '', email: 'invalid-email' };

    // Act
    await exampleHandler(mockRequest as Request, mockResponse as Response);

    // Assert
    expect(mockResponse.status).toHaveBeenCalledWith(400);
    expect(mockResponse.json).toHaveBeenCalledWith({
      message: expect.stringContaining('validation'),
    });
  });
});
```

### Testing de Services

```typescript
describe('externalApiService', () => {
  const mockRestClient = {
    post: jest.fn(),
    get: jest.fn(),
  };

  beforeEach(() => {
    jest.mocked(RestClient).mockReturnValue(mockRestClient);
  });

  it('should return data when API call succeeds', async () => {
    // Arrange
    const mockData = { id: 1, name: 'Test' };
    mockRestClient.post.mockResolvedValue({ data: mockData });

    // Act
    const result = await externalApiService({ data: mockData });

    // Assert
    expect(result).toEqual(mockData);
    expect(mockRestClient.post).toHaveBeenCalledWith('/external-api', {
      headers: { 'Content-Type': 'application/json' },
      data: mockData,
    });
  });

  it('should throw error when API call fails', async () => {
    // Arrange
    const errorResponse = {
      response: { status: 500, data: { message: 'Server Error' } },
    };
    mockRestClient.post.mockRejectedValue(errorResponse);

    // Act & Assert
    await expect(externalApiService({ data: {} })).rejects.toThrow('Server Error');
  });
});
```

### Testing de Error Handling

```typescript
describe('handleCatch', () => {
  it('should return BadRequest error when API returns status 400', () => {
    // Arrange
    const error = {
      response: {
        status: 400,
        data: { message: 'Bad Request' },
      },
    };

    // Act
    const { error: result } = handleCatch(error);

    // Assert
    expect(result).toBeInstanceOf(BadRequest);
    expect(result.message).toBe('Bad Request');
  });

  it('should return UnhandledError when status is not mapped', () => {
    // Arrange
    const error = {
      response: {
        status: 999,
      },
    };

    // Act
    const { error: result } = handleCatch(error);

    // Assert
    expect(result).toBeInstanceOf(UnhandledError);
  });
});
```

## Estrat√©gias de Mocking

### Mocking de APIs Externas

```typescript
// Mock do Nordic RestClient
jest.mock('nordic/restclient', () => ({
  RestClient: jest.fn(() => ({
    post: jest.fn(),
    get: jest.fn(),
    put: jest.fn(),
    delete: jest.fn(),
  })),
}));

// Mock do Nordic Logger
jest.mock('nordic/logger', () => ({
  LoggerFactory: jest.fn(() => ({
    info: jest.fn(),
    error: jest.fn(),
    warn: jest.fn(),
  })),
}));
```

### Mocking de Autentica√ß√£o

```typescript
// Mock do Odin Security
jest.mock('odin/security', () => ({
  authentication: jest.fn(() => (req, res, next) => {
    req.auth = { user: { userId: 'test-user' } };
    next();
  }),
  authorization: jest.fn(() => (req, res, next) => next()),
}));
```

### Mocking de Middleware

```typescript
// Mock de middleware customizado
jest.mock('../middlewares/contextMiddleware', () => ({
  contextMiddleware: jest.fn((req, res, next) => {
    req.context = { requestId: 'test-request' };
    next();
  }),
}));
```

### Diretrizes Globais de Mocking
- Fazer mock de todas as depend√™ncias externas
- N√£o fazer mock do que j√° est√° mockado em `./tests/unit/setupTests.backend.ts`
- Limpar mocks entre testes usando `jest.clearAllMocks()`
- Mock espec√≠fico por teste quando necess√°rio

## Padr√£o Builder para Testes

### Test Data Builders para BFF

```typescript
class RequestBuilder {
  private request: Partial<Request> = {
    body: {},
    params: {},
    query: {},
    headers: {},
  };

  withBody(body: any): RequestBuilder {
    this.request.body = body;
    return this;
  }

  withAuth(user: any): RequestBuilder {
    this.request.auth = { user };
    return this;
  }

  withContext(context: any): RequestBuilder {
    this.request.context = context;
    return this;
  }

  build(): Partial<Request> {
    return { ...this.request };
  }
}

// Usage in tests
const mockRequest = new RequestBuilder()
  .withBody({ name: 'Test' })
  .withAuth({ userId: 'test-user' })
  .withContext({ requestId: 'test-request' })
  .build();
```

## Melhores Pr√°ticas de Testing BFF

### Qualidade dos Testes
- Escrever nomes de testes claros e descritivos
- Testar uma funcionalidade por vez
- Usar assertions significativas
- Evitar testar detalhes de implementa√ß√£o
- Testar casos extremos e cen√°rios de erro

### Performance
- Manter testes r√°pidos e focados
- Evitar chamadas de API reais
- Usar m√©todos de cleanup apropriados
- Fazer mock de depend√™ncias pesadas

### Manutenibilidade
- Manter testes simples e leg√≠veis
- Usar fun√ß√µes auxiliares para setup comum
- Evitar c√≥digo duplicado nos testes
- Atualizar testes quando requisitos mudarem

### Diretrizes de Cobertura
- Buscar alta cobertura de testes mas focar em qualidade sobre quantidade
- Priorizar testes de l√≥gica de neg√≥cio cr√≠tica
- Testar handlers de API e workflows
- Incluir cen√°rios de tratamento de erros

## Cen√°rios Comuns de Testing BFF

### Testing de Valida√ß√£o Zod

```typescript
describe('validation', () => {
  it('should validate request body successfully', () => {
    // Arrange
    const validData = { name: 'Test', email: 'test@example.com' };

    // Act
    const result = CreateUserRequestSchema.parse(validData);

    // Assert
    expect(result).toEqual(validData);
  });

  it('should throw validation error for invalid data', () => {
    // Arrange
    const invalidData = { name: '', email: 'invalid' };

    // Act & Assert
    expect(() => CreateUserRequestSchema.parse(invalidData)).toThrow();
  });
});
```

### Testing de Middleware

```typescript
describe('contextMiddleware', () => {
  let mockRequest: Partial<Request>;
  let mockResponse: Partial<Response>;
  let nextFunction: jest.Mock;

  beforeEach(() => {
    mockRequest = {};
    mockResponse = {};
    nextFunction = jest.fn();
  });

  it('should add context to request', () => {
    // Act
    contextMiddleware(mockRequest as Request, mockResponse as Response, nextFunction);

    // Assert
    expect(mockRequest.context).toBeDefined();
    expect(nextFunction).toHaveBeenCalled();
  });
});
```

### Testing de Upload de Arquivos

```typescript
describe('file upload handler', () => {
  it('should handle file upload successfully', async () => {
    // Arrange
    const mockFile = {
      originalname: 'test.pdf',
      mimetype: 'application/pdf',
      size: 1024,
    };
    mockRequest.files = [mockFile];

    // Act
    await uploadHandler(mockRequest as Request, mockResponse as Response);

    // Assert
    expect(mockResponse.json).toHaveBeenCalledWith({
      files: expect.arrayContaining([
        expect.objectContaining({
          filename: 'test.pdf',
          status: 'uploaded',
        }),
      ]),
    });
  });
});
```

## Debug de Testes

### Problemas Comuns
- Mocks n√£o configurados corretamente
- Falta de cleanup entre testes
- Depend√™ncias n√£o mockadas
- Testar implementa√ß√£o ao inv√©s de comportamento

### Ferramentas de Debug
- Usar `console.log` para debug de valores
- Verificar hist√≥rico de chamadas de mock com `toHaveBeenCalledWith`
- Usar `jest.spyOn` para monitorar chamadas
- Verificar se mocks est√£o sendo limpos corretamente

### Isolamento de Testes
- Garantir que testes n√£o dependem uns dos outros
- Limpar efeitos colaterais em `afterEach`
- Resetar mocks entre testes
- Evitar estado mut√°vel compartilhado

## Comandos de Verifica√ß√£o

### Sequ√™ncia Obrigat√≥ria de Comandos

**SEMPRE execute nesta ordem para economizar recursos:**

```bash
# 1. PRIMEIRO: Verificar lint apenas no arquivo espec√≠fico (r√°pido, detecta erros de sintaxe)
npx eslint api/handlers/example/example.ts

# 2. SEGUNDO: Se lint passou, executar apenas o teste espec√≠fico
npm test example.spec.ts

# Comandos alternativos para testes espec√≠ficos:
npm test -- --testNamePattern="example"     # Testes que contenham "example" no nome
npm test example.spec.ts --watch           # Modo watch para o arquivo espec√≠fico
npm test example.spec.ts --coverage        # Com relat√≥rio de cobertura do arquivo
```

### Tratamento de Erros

**Se lint falhar:**
- Corrigir TODOS os erros de lint no arquivo espec√≠fico antes de prosseguir
- N√£o executar testes at√© lint do arquivo estar limpo
- Usar `npx eslint [arquivo] --fix` para corre√ß√µes autom√°ticas

**Se testes falharem:**
- Analisar mensagens de erro detalhadamente
- Corrigir implementa√ß√£o ou testes conforme necess√°rio
- Re-executar apenas o teste espec√≠fico at√© passar
- Verificar se n√£o h√° testes flaky (inst√°veis)

### Comandos para LLM

**USAR SEMPRE `run_terminal_cmd` com estes comandos:**
- `npx eslint [caminho/do/arquivo]` - Verifica√ß√£o de lint no arquivo espec√≠fico
- `npm test [arquivo.spec.ts]` - Execu√ß√£o do teste espec√≠fico
- `npx eslint [arquivo] --fix` - Corre√ß√£o autom√°tica de lint no arquivo
- `npm test [arquivo.spec.ts] --watch` - Modo watch para desenvolvimento

### Exemplos Pr√°ticos

```bash
# Para um handler de API:
npx eslint api/handlers/users/create-user.ts
npm test create-user.spec.ts

# Para um service:
npx eslint services/external-api/external-api.ts
npm test external-api.spec.ts

# Para um middleware:
npx eslint middlewares/contextMiddleware.ts
npm test contextMiddleware.spec.ts
```

## Checklist de Valida√ß√£o para LLM

Antes de finalizar os testes, OBRIGATORIAMENTE verificar:
**PRIORIZE**: Itens marcados como "Cr√≠tico" na [Matriz de Prioridades](mdc:#0-matriz-de-prioridades)

### ‚úÖ Cr√≠tico (Bloqueia entrega)
- [ ] Lint executado sem erros no arquivo espec√≠fico
- [ ] Teste espec√≠fico executado com `npm test [arquivo.spec.ts]`
- [ ] Teste espec√≠fico passando sem falhas
- [ ] Nomenclatura correta: `.spec.ts` ou `.spec.js`

### ‚úÖ Importante (Impacta qualidade)
- [ ] AAA pattern seguido (Arrange-Act-Assert)
- [ ] Mocks de APIs externas implementados
- [ ] Cen√°rios de sucesso e erro testados
- [ ] Estrutura de describe/it organizada

**IMPORTANTE**: N√£o finalize sem completar itens "Cr√≠ticos".
