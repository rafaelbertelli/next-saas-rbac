---
description: 
globs: 
alwaysApply: true
---
---
description: Backend development guidelines
globs: ["app/api/*"]
alwaysApply: true
---

# Fastify Backend Development Guidelines

## Instru√ß√µes para LLM

**A√á√ÉO OBRIGAT√ìRIA**: Quando solicitado para desenvolver c√≥digo backend, siga EXATAMENTE esta sequ√™ncia:

1. **ANALISAR**: Execute an√°lise t√©cnica completa antes de qualquer implementa√ß√£o
2. **ESTRUTURAR**: Organize o desenvolvimento seguindo os padr√µes estabelecidos
3. **IMPLEMENTAR**: Use os patterns e melhores pr√°ticas definidas
4. **VERIFICAR**: Execute `npx eslint [arquivo]` no arquivo espec√≠fico
5. **VALIDAR**: Confirme que seguiu todas as diretrizes antes de finalizar

**IMPORTANTE**: Execute lint apenas no arquivo espec√≠fico para economia de recursos.

## Fluxo de Desenvolvimento Linear

```
IN√çCIO
  ‚Üì
üìã Consultar [Matriz de Prioridades](mdc:#0-matriz-de-prioridades)
  ‚Üì
üîç Executar [An√°lise T√©cnica](mdc:#1-an√°lise-t√©cnica)
  ‚Üì
üõ†Ô∏è Aplicar [Fastify Patterns](mdc:#3-fastify-patterns) + [Service Layer](mdc:#4-service-layer)
  ‚Üì
‚öñÔ∏è Conflito? ‚Üí [Resolu√ß√£o de Conflitos](mdc:#resolu√ß√£o-de-conflitos)
  ‚Üì
‚úÖ [Verifica√ß√£o e Valida√ß√£o](mdc:#9-verifica√ß√£o-e-valida√ß√£o)
  ‚Üì
üéØ FINALIZADO
```

## Modo R√°pido (Para mudan√ßas simples)

**Use quando**: Pequenas corre√ß√µes, ajustes de configura√ß√£o, ou mudan√ßas triviais

**Processo simplificado**:
1. ‚úÖ Verificar se √© realmente simples (sem l√≥gica complexa)
2. üõ†Ô∏è Implementar seguindo padr√µes b√°sicos
3. üîç Executar `npx eslint [arquivo]`
4. ‚úÖ Validar apenas itens "Cr√≠ticos" do checklist

**Pular para casos simples**: An√°lise detalhada, documenta√ß√£o extensa, valida√ß√£o completa

## Quando Aplicar

Esta rule deve ser aplicada quando:
- Desenvolver rotas de API com Fastify
- Implementar middleware de autentica√ß√£o/autoriza√ß√£o
- Criar servi√ßos de l√≥gica de neg√≥cio
- Implementar reposit√≥rios com Prisma
- Implementar tratamento de erros customizado
- Configurar logging e monitoramento
- Desenvolver valida√ß√µes de entrada/sa√≠da com Zod

## √çndice de Navega√ß√£o R√°pida

- üö® [Matriz de Prioridades](mdc:#0-matriz-de-prioridades) - **Consulte PRIMEIRO**
- ‚öñÔ∏è [Resolu√ß√£o de Conflitos](mdc:#resolu√ß√£o-de-conflitos) - Para decis√µes dif√≠ceis
- üîç [An√°lise T√©cnica](mdc:#1-an√°lise-t√©cnica) - In√≠cio do desenvolvimento
- üõ†Ô∏è [Fastify Patterns](mdc:#3-fastify-patterns) - Durante implementa√ß√£o
- ‚úÖ [Checklist Final](mdc:#9-verifica√ß√£o-e-valida√ß√£o) - Antes de finalizar

## 0. Matriz de Prioridades

### Cr√≠tico (Bloqueia desenvolvimento)
- Lint sem erros
- Tipos TypeScript corretos
- Tratamento de erro implementado
- Autentica√ß√£o/autoriza√ß√£o funcionais

### Importante (Impacta qualidade)
- Logging apropriado com Pino
- Valida√ß√£o de entrada/sa√≠da com Zod
- Estrutura de rotas seguida
- Padr√µes de nomenclatura seguidos

### Opcional (Melhoria incremental)
- Otimiza√ß√µes de performance
- Documenta√ß√£o adicional
- Monitoramento avan√ßado

## Resolu√ß√£o de Conflitos

### Ordem de Preced√™ncia:
1. **Seguran√ßa > Performance**: Nunca comprometa seguran√ßa por performance
2. **Funcionalidade > Padr√µes**: Se um padr√£o impede a funcionalidade, priorize a funcionalidade
3. **Legibilidade > Otimiza√ß√£o**: C√≥digo leg√≠vel √© mais importante que micro-otimiza√ß√µes
4. **Conven√ß√µes do projeto > Prefer√™ncias pessoais**: Siga o que j√° existe no projeto

### Protocolo de Decis√£o:
1. **Identifique o conflito**: Qual diretriz est√° sendo violada?
2. **Consulte a preced√™ncia**: Use a ordem acima para decidir
3. **Documente a exce√ß√£o**: Explique por que divergiu
4. **Valide o m√≠nimo**: Garanta que itens "Cr√≠ticos" ainda s√£o atendidos

### Exemplos Pr√°ticos:
```typescript
// ‚ùå Conflito: Performance vs Seguran√ßa
// Performance diz: cache dados sens√≠veis
// Mas: dados cont√™m informa√ß√µes pessoais

// ‚úÖ Resolu√ß√£o: Priorizar seguran√ßa
// N√£o fazer cache de dados sens√≠veis, implementar cache seletivo
```

### Quando Divergir:
- **Documente**: Adicione coment√°rio explicando a exce√ß√£o
- **Valide cr√≠ticos**: Confirme que seguran√ßa e funcionalidade n√£o s√£o comprometidas
- **Priorize entrega**: Funcionalidade working > padr√£o perfeito

## 1. An√°lise T√©cnica

**ANTES DE INICIAR**: Consulte a [Matriz de Prioridades](mdc:#0-matriz-de-prioridades)

### Processo de An√°lise
**EXECUTAR OBRIGATORIAMENTE antes de qualquer implementa√ß√£o:**

- **Requisitos**: Identificar funcionalidades de API necess√°rias
- **Seguran√ßa**: Mapear necessidades de autentica√ß√£o/autoriza√ß√£o
- **Integra√ß√£o**: Verificar APIs externas e depend√™ncias
- **Performance**: Analisar necessidades de cache e otimiza√ß√£o

**FERRAMENTAS**: Use `codebase_search` e `read_file` para analisar c√≥digo existente.

### Diretrizes de An√°lise
- Identifique requisitos de seguran√ßa e performance
- Use `codebase_search` e `read_file` para contexto
- Documente decis√µes importantes de arquitetura
- Prossiga com implementa√ß√£o quando abordagem estiver clara

## 2. Technology Stack

### Core Technologies
- **Runtime**: Node.js
- **Framework**: Fastify
- **Language**: TypeScript
- **ORM**: Prisma
- **Authentication**: @fastify/jwt
- **Logging**: Pino (built-in do Fastify)
- **Validation**: Zod + fastify-type-provider-zod
- **Testing**: Jest + ts-jest
- **Database**: PostgreSQL

### Role Definition
Voc√™ √© um engenheiro backend s√™nior especializado em Node.js, Fastify, TypeScript, Prisma, e desenvolvimento de APIs REST.

## 3. Fastify Patterns

### Route Structure
- Use async function ou const para exports (ambos padr√µes aceitos)
- Implemente tratamento de erro via throw de classes customizadas
- Use `request` e `reply` como par√¢metros (n√£o `req`/`res`)
- Use middleware de autentica√ß√£o quando necess√°rio
- Estruture em pasta pr√≥pria com `route.ts`, `schema.ts` e `index.ts`

```typescript
import { authMiddleware } from "@/http/middlewares/auth";
import { prisma } from "@/infra/prisma/prisma-connection";
import { NotFoundError } from "@/routes/_error/4xx/not-found-error";
import { FastifyInstance } from "fastify";
import { ZodTypeProvider } from "fastify-type-provider-zod";
import { userProfileSchema } from "./schema";

export const userProfileRoute = async (app: FastifyInstance) => {
  app
    .withTypeProvider<ZodTypeProvider>()
    .register(authMiddleware)
    .get(
      "/users",
      {
        schema: userProfileSchema,
      },
      async (request, reply) => {
        const userId = await request.getCurrentUserId();

        const user = await prisma.user.findUnique({
          select: {
            id: true,
            name: true,
            email: true,
            avatarUrl: true,
          },
          where: {
            id: userId,
          },
        });

        if (!user) {
          throw new NotFoundError("User not found");
        }

        return reply.status(200).send({
          data: {
            user,
          },
        });
      }
    );
};
```

### Route POST Pattern
```typescript
import { authMiddleware } from "@/http/middlewares/auth";
import { createOrganizationService } from "@/services/organizations/create-organization";
import { FastifyInstance } from "fastify";
import { ZodTypeProvider } from "fastify-type-provider-zod";
import { createOrganizationSchema } from "./schema";

export async function createOrganizationRoute(app: FastifyInstance) {
  app
    .withTypeProvider<ZodTypeProvider>()
    .register(authMiddleware)
    .post(
      "/organizations",
      {
        schema: createOrganizationSchema,
      },
      async (request, reply) => {
        const userId = await request.getCurrentUserId();
        const { name, domain, shouldAttachUsersByDomain } = request.body;

        const newOrganization = await createOrganizationService({
          userId,
          name,
          domain,
          shouldAttachUsersByDomain,
        });

        return reply.status(201).send({
          message: "Organization created successfully",
          data: {
            organizationId: newOrganization.id,
          },
        });
      }
    );
}
```

### Schema Patterns
- Use `body` para definir schema de entrada
- Use `response` para definir schemas de resposta
- Inclua `tags` para organiza√ß√£o no Swagger
- Inclua `summary` para documenta√ß√£o
- Use `security` para rotas autenticadas

```typescript
import { z } from "zod";

export const createOrganizationSchema = {
  tags: ["organizations"],
  summary: "Create a new organization",
  security: [
    {
      bearerAuth: [],
    },
  ],
  body: z.object({
    name: z.string(),
    domain: z.string().nullish(),
    shouldAttachUsersByDomain: z.boolean().optional(),
  }),
  response: {
    201: z.object({
      message: z.string(),
      data: z.object({
        organizationId: z.string().uuid(),
      }),
    }),
  },
};
```

### Middleware Patterns
- Use fastify-plugin para encapsular middleware
- Use hooks (`preHandler`) para interceptar requests
- Adicione m√©todos ao request via decora√ß√£o

```typescript
import { getCurrentUserId } from "@/services/users/get-current-user-id";
import { FastifyInstance } from "fastify";
import fastifyPlugin from "fastify-plugin";

export const authMiddleware = fastifyPlugin(async (app: FastifyInstance) => {
  app.addHook("preHandler", async (request, reply) => {
    request.getCurrentUserId = async () => await getCurrentUserId(request);
  });
});
```

### Error Handling Patterns
- Use classes de erro customizadas com statusCode
- Throw erros diretamente nas rotas/services
- Error handler global processa e responde automaticamente

```typescript
export class NotFoundError extends Error {
  public statusCode = 404;

  constructor(message?: string) {
    super(message ?? "Not Found");
  }
}

// No handler de rota
if (!user) {
  throw new NotFoundError("User not found");
}
```

### File Structure Pattern
```
src/routes/users/user-profile/
‚îú‚îÄ‚îÄ user-profile.route.ts    # Implementa√ß√£o da rota
‚îú‚îÄ‚îÄ schema.ts                # Schema Zod para valida√ß√£o
‚îî‚îÄ‚îÄ index.ts                 # Export: export * from "./user-profile.route";
```

## 4. Service Layer

### Service Structure
- Use functions ao inv√©s de classes
- Defina tipos TypeScript para par√¢metros
- Separe l√≥gica de neg√≥cio das rotas
- Use reposit√≥rios para acesso a dados
- Retorne dados estruturados

```typescript
import { createOrganizationRepository } from "@/repositories/organizations/create-organization";
import { createSlug } from "@/utils/slug/create-slug";

type CreateOrganization = {
  userId: string;
  name: string;
  domain?: string | null;
  shouldAttachUsersByDomain?: boolean;
};

export async function createOrganizationService({
  userId,
  name,
  domain,
  shouldAttachUsersByDomain = false,
}: CreateOrganization) {
  const slug = createSlug(name);

  const organization = await createOrganizationRepository({
    userId,
    name,
    domain,
    slug,
    shouldAttachUsersByDomain,
  });

  return organization;
}
```

### Authentication Service Pattern
- Use @fastify/jwt diretamente via request.jwtVerify
- Throw UnauthorizedError para erros de auth
- Valide presence do `sub` claim

```typescript
import { UnauthorizedError } from "@/routes/_error/4xx/unauthorized-error";
import { FastifyRequest } from "fastify";

export async function getCurrentUserId(request: FastifyRequest) {
  try {
    const { sub } = await request.jwtVerify<{ sub: string }>();

    if (!sub) {
      throw new UnauthorizedError("Invalid token");
    }

    return sub;
  } catch (error) {
    throw new UnauthorizedError("Invalid token");
  }
}
```

## 5. Repository Layer

### Repository Structure
- Use Prisma client diretamente
- Implemente try/catch com erros espec√≠ficos
- Use transa√ß√µes para opera√ß√µes complexas
- Defina tipos para par√¢metros

```typescript
import { prisma } from "@/infra/prisma/prisma-connection";

type CreateOrganizationRepository = {
  userId: string;
  name: string;
  domain?: string | null;
  slug: string;
  shouldAttachUsersByDomain: boolean;
};

export async function createOrganizationRepository({
  userId,
  name,
  domain,
  slug,
  shouldAttachUsersByDomain,
}: CreateOrganizationRepository) {
  try {
    const organization = await prisma.organization.create({
      data: {
        name,
        domain,
        slug,
        shouldAttachUsersByDomain,
        ownerId: userId,
        members: {
          create: {
            userId,
            role: "ADMIN",
          },
        },
      },
    });

    return organization;
  } catch (error) {
    throw new Error("Failed to create organization");
  }
}
```

### Prisma Configuration
- Use tipos gerados em `@/generated/prisma`
- Configure logging para desenvolvimento
- Centralize conex√£o em arquivo espec√≠fico

```typescript
import { PrismaClient } from "@/generated/prisma";

export const prisma = new PrismaClient({
  log: ["info", "query", "warn", "error"],
});
```

## 6. Input Validation

### Zod Schema Patterns
- Use fastify-type-provider-zod para valida√ß√£o autom√°tica
- Defina schemas no arquivo `schema.ts`
- Use `.nullish()` para campos opcionais que podem ser null
- Use `.optional()` para campos truly opcionais

```typescript
import { z } from 'zod';

// No schema.ts
export const createUserSchema = {
  body: z.object({
    name: z.string(),
    email: z.string().email(),
    domain: z.string().nullish(), // pode ser string, null ou undefined
    shouldAttach: z.boolean().optional(), // pode ser boolean ou undefined
  })
};

// Inferindo tipos
type CreateUserRequest = z.infer<typeof createUserSchema.body>;
```

### Runtime Validation
- Valida√ß√£o autom√°tica via schema na rota
- Erros tratados pelo error handler global
- Acesso a dados validados via `request.body`

## 7. Security Patterns

### JWT Configuration
```typescript
// No server.ts
app.register(fastifyJwt, {
  secret: env.JWT_SECRET,
  sign: { algorithm: "HS256" },
});
```

### Authentication Middleware
```typescript
export const authMiddleware = fastifyPlugin(async (app: FastifyInstance) => {
  app.addHook("preHandler", async (request, reply) => {
    request.getCurrentUserId = async () => await getCurrentUserId(request);
  });
});
```

### Data Protection
- Sanitize dados sens√≠veis antes de retornar
- Use select espec√≠fico no Prisma
- Nunca retorne passwordHash ou tokens

```typescript
const user = await prisma.user.findUnique({
  select: {
    id: true,
    name: true,
    email: true,
    avatarUrl: true,
    // passwordHash: false (n√£o incluir)
  },
  where: { id: userId },
});
```

## 8. Implementation Guidelines

### Padr√µes Obrigat√≥rios
- Use import/export ES6
- Defina tipos TypeScript expl√≠citos
- Implemente tratamento de erro robusto
- Use async/await consistentemente
- Estruture c√≥digo em camadas (routes -> services -> repositories)

### Estrutura de Pastas EXATA
```
apps/api/src/
‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îú‚îÄ‚îÄ server.ts
‚îÇ   ‚îî‚îÄ‚îÄ middlewares/
‚îÇ       ‚îî‚îÄ‚îÄ auth.ts
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ _error/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error-handler.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 4xx/
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user-profile/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ user-profile.route.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ schema.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ organizations/
‚îÇ   ‚îú‚îÄ‚îÄ projects/
‚îÇ   ‚îú‚îÄ‚îÄ session/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ organizations/
‚îÇ   ‚îî‚îÄ‚îÄ projects/
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ organizations/
‚îÇ   ‚îî‚îÄ‚îÄ projects/
‚îú‚îÄ‚îÄ infra/
‚îÇ   ‚îî‚îÄ‚îÄ prisma/
‚îÇ       ‚îî‚îÄ‚îÄ prisma-connection.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ slug/
‚îÇ       ‚îî‚îÄ‚îÄ create-slug.ts
‚îî‚îÄ‚îÄ generated/
    ‚îî‚îÄ‚îÄ prisma/
```

### Import Patterns
```typescript
// Sempre use path absoluto com @/
import { prisma } from "@/infra/prisma/prisma-connection";
import { authMiddleware } from "@/http/middlewares/auth";
import { NotFoundError } from "@/routes/_error/4xx/not-found-error";
import { getCurrentUserId } from "@/services/users/get-current-user-id";
```

### Export Patterns
```typescript
// Em index.ts
export * from "./user-profile.route";

// Em arquivos principais
export const routeName = async (app: FastifyInstance) => { /* */ };
export async function serviceName() { /* */ }
export async function repositoryName() { /* */ }
```

### Response Patterns
```typescript
// Sucesso com dados
return reply.status(200).send({
  data: { user },
});

// Sucesso com mensagem
return reply.status(201).send({
  message: "Organization created successfully",
  data: { organizationId: newOrganization.id },
});

// Erro via throw
throw new NotFoundError("User not found");
```

## 9. Verifica√ß√£o e Valida√ß√£o

### Lint Verification
**IMPORTANTE**: Instale eslint se n√£o estiver dispon√≠vel: `pnpm add -D eslint @repo/eslint-config`

Execute `npx eslint [arquivo]` no arquivo espec√≠fico antes de finalizar.

**Exemplos EXATOS baseados na estrutura:**
```bash
# Para rota:
npx eslint apps/api/src/routes/users/user-profile/user-profile.route.ts

# Para service:
npx eslint apps/api/src/services/organizations/create-organization/create-organization.service.ts

# Para repository:
npx eslint apps/api/src/repositories/organizations/create-organization/create-organization.repository.ts
```

**Se eslint n√£o estiver instalado:**
```bash
# No root do projeto
pnpm add -D eslint

# Ou no app espec√≠fico
cd apps/api && pnpm add -D eslint
```

### Checklist de Valida√ß√£o para LLM

#### ‚úÖ Cr√≠tico (Bloqueia entrega)
- [ ] Lint executado sem erros no arquivo espec√≠fico
- [ ] Tipos TypeScript corretos (sem `any`)
- [ ] Tratamento de erro implementado (throw classes customizadas)
- [ ] Autentica√ß√£o/autoriza√ß√£o funcionais (quando aplic√°vel)
- [ ] Estrutura de pastas seguida exatamente
- [ ] Imports usando path absoluto (@/)

#### ‚úÖ Importante (Impacta qualidade)
- [ ] Schema Zod definido corretamente
- [ ] Response structured com `data` wrapper
- [ ] Service/Repository separation mantida
- [ ] Error classes com statusCode
- [ ] Async/await usado consistentemente

#### ‚úÖ Opcional (Melhoria incremental)
- [ ] Logging implementado onde apropriado
- [ ] Documenta√ß√£o no schema (summary, tags)
- [ ] Valida√ß√£o de edge cases

**IMPORTANTE**: N√£o finalize sem completar itens "Cr√≠ticos".

## Documentation e Tools

### Swagger/OpenAPI
- Configurado automaticamente via fastify-swagger
- Schemas Zod geram documenta√ß√£o automaticamente
- Dispon√≠vel em `/docs` em desenvolvimento

### TypeScript Extension
- Extens√µes de tipos em `@types/fastify.d.ts`
- Decora√ß√£o de request com m√©todos customizados

```typescript
// Em @types/fastify.d.ts
declare module "fastify" {
  interface FastifyRequest {
    getCurrentUserId: () => Promise<string>;
  }
}
```
